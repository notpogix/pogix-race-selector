<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pogix Plinko Race â€” No Bins, Visible Finish</title>
<style>
  :root{
    --bg:#071827;
    --panel:#0b1220;
    --accent:#06b6d4;
    --text:#e6eef6;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{
    background:linear-gradient(180deg,#04101a 0%, #071827 60%);
    color:var(--text);
    display:flex;
    gap:32px;
    padding:32px;
    align-items:stretch;
  }
  .sidebar{
    width:480px;
    background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.015));
    border-radius:24px;
    padding:28px;
    box-shadow:0 20px 60px rgba(2,6,23,0.9);
    display:flex;
    flex-direction:column;
  }
  .sidebar h3{
    margin:10px 0 18px 0;
    font-size:26px;
    color:var(--accent);
    font-weight:700;
  }
  .inputRow{
    display:flex;
    gap:14px;
    margin-bottom:22px;
  }
  .inputRow input{
    flex:1;
    padding:18px 16px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.16);
    background:rgba(2,6,23,0.65);
    color:var(--text);
    outline:none;
    font-size:18px;
  }
  .inputRow input::placeholder{
    color:rgba(255,255,255,0.4);
  }
  .controls{
    display:flex;
    gap:14px;
    margin-bottom:22px;
    flex-wrap:wrap;
  }
  button{
    padding:18px 22px;
    border-radius:14px;
    border:none;
    background:var(--accent);
    color:#021018;
    cursor:pointer;
    font-weight:700;
    font-size:18px;
    letter-spacing:0.02em;
    transition:all 0.18s;
  }
  button:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 30px rgba(6,182,212,0.45);
  }
  button.ghost{
    background:transparent;
    border:1px solid rgba(255,255,255,0.2);
    color:var(--text);
  }
  button.danger{
    background:#ef4444;
    color:#fee2e2;
  }
  button.ghost:hover{
    background:rgba(255,255,255,0.08);
    border-color:rgba(255,255,255,0.3);
  }

  .namesList{
    max-height:30vh;
    overflow:auto;
    padding:14px;
    border-radius:16px;
    background:rgba(15,23,42,0.85);
    border:1px solid rgba(148,163,184,0.35);
  }
  .nameItem{
    display:flex;
    align-items:center;
    gap:18px;
    padding:12px 14px;
    border-radius:14px;
    margin:10px 0;
    background:rgba(15,23,42,0.96);
    border:1px solid rgba(148,163,184,0.4);
    transition:all 0.16s;
  }
  .nameItem:hover{
    background:rgba(30,64,175,0.35);
    transform:translateX(4px);
  }
  .colorDot{
    width:32px;
    height:32px;
    border-radius:50%;
    box-shadow:0 0 0 3px rgba(255,255,255,0.26) inset, 0 6px 18px rgba(0,0,0,0.8);
  }

  /* Sidebar leaderboard under names, scrollable */
  .sidebarLeaderboardWrap{
    margin-top:18px;
  }
  .sidebarLeaderboardTitle{
    margin:0 0 8px 0;
    font-size:18px;
    color:var(--accent);
    font-weight:700;
  }
  .sidebarLeaderboard{
    max-height:28vh;
    overflow:auto;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.5);
  }

  .leaderboardItem{
    display:flex;
    align-items:center;
    gap:10px;
    padding:4px 2px;
    font-size:15px;
  }
  .leaderboardRank{
    width:32px;
    text-align:right;
    font-weight:700;
    color:rgba(226,232,240,0.9);
  }
  .leaderboardDot{
    width:14px;
    height:14px;
    border-radius:50%;
    box-shadow:0 0 0 2px rgba(15,23,42,0.8);
  }
  .leaderboardName{
    flex:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    color:rgba(226,232,240,0.96);
  }
  .leaderboardDist{
    font-size:13px;
    color:rgba(148,163,184,0.95);
    text-align:right;
    min-width:70px;
  }

  .main{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:20px;
    position:relative;
  }
  .canvasWrap{
    flex:1;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
    border-radius:24px;
    padding:20px;
    display:flex;
    flex-direction:column;
    position:relative;
  }
  #gameCanvas{
    width:100%;
    height:100%;
    border-radius:20px;
    background:linear-gradient(180deg,#071827,#020617);
    display:block;
    box-shadow:0 20px 60px rgba(2,6,23,0.95);
  }
  .footer{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px 20px;
    color:rgba(226,232,240,0.9);
    background:rgba(15,23,42,0.9);
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.45);
    font-size:18px;
  }
  .modal{
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:#020617;
    padding:32px;
    border-radius:24px;
    box-shadow:0 26px 80px rgba(2,6,23,0.95);
    min-width:620px;
    max-width:720px;
    z-index:40;
    border:1px solid rgba(148,163,184,0.6);
  }
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.82);
    z-index:30;
  }
  .modal h2{
    margin:0 0 14px 0;
    color:var(--accent);
    font-size:30px;
  }
  .modal p{
    margin:0 0 20px 0;
    font-size:18px;
  }
  .modal .opts{
    display:flex;
    gap:14px;
    justify-content:flex-end;
    flex-wrap:wrap;
  }
  .small{
    font-size:17px;
    color:rgba(203,213,225,0.9);
  }
  .namesList::-webkit-scrollbar,
  .sidebarLeaderboard::-webkit-scrollbar{width:12px}
  .namesList::-webkit-scrollbar-thumb,
  .sidebarLeaderboard::-webkit-scrollbar-thumb{
    background:rgba(148,163,184,0.55);
    border-radius:8px;
  }
  .namesList::-webkit-scrollbar-track,
  .sidebarLeaderboard::-webkit-scrollbar-track{
    background:rgba(15,23,42,0.6);
  }

  @media (max-width:1200px){
    body{
      flex-direction:column;
      padding:20px;
      gap:20px;
    }
    .sidebar{
      width:100%;
      max-width:600px;
    }
    .controls{
      justify-content:center;
    }
  }
</style>
</head>
<body>
  <div class="sidebar">
    <h3>Pogix Plinko Race</h3>

    <div class="inputRow">
      <input id="nameInput" placeholder="Type participant name and press Enter..." />
      <button id="addBtn">Add</button>
    </div>

    <div class="controls">
      <button id="startBtn">Start Race</button>
      <button id="pauseBtn" class="ghost">Pause</button>
      <button id="endBtn" class="danger">End Race</button>
      <button id="restartBtn" class="ghost">Restart</button>
    </div>

    <h3 style="margin-top:12px">Participants</h3>
    <div class="namesList" id="namesList"></div>

    <!-- Sidebar leaderboard under names -->
    <div class="sidebarLeaderboardWrap">
      <h3 class="sidebarLeaderboardTitle">Leaderboard</h3>
      <div class="sidebarLeaderboard" id="sidebarLeaderboard">
        <div style="font-size:14px;color:rgba(148,163,184,0.95);">
          Start a race to see live positions.
        </div>
      </div>
    </div>

    <div style="margin-top:16px">
      <div class="small">
        Type a name and press Enter or click Add.<br>
        Pause freezes the simulation.
      </div>
    </div>
  </div>

  <div class="main">
    <div class="canvasWrap">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div class="footer">
      <div class="small">Balls: <span id="ballCount">0</span> â€¢ Finished: <span id="finishedCount">0</span></div>
    </div>
  </div>

  <div id="overlay" class="overlay" style="display:none"></div>
  <div id="modal" class="modal" style="display:none">
    <h2 id="modalTitle">Leaderboard</h2>
    <p id="modalBody"></p>
    <div class="opts">
      <button id="restartAll">â†»</button>
      <button id="restartElimLast" class="ghost">â†» (Eliminate Last Place)</button>
    </div>
  </div>

<script>
const SCALE_BALL = 1.05;
const SCALE_PEG = 1.05;
const SCALE_SPACING = 1.05;

const BALL_RADIUS = 12 * SCALE_BALL;
const PEG_RADIUS = 6 * SCALE_PEG;
const PEG_SPACING_X = 56 * SCALE_SPACING;
const PEG_SPACING_Y = 48 * SCALE_SPACING;

const GRAVITY = 0.024;
const FRICTION = 0.9992;
const WALL_BOUNCE = 0.82;   // slightly higher to help escape
const WALL_NUDGE = 0.6;     // small nudge away from walls

const FINISH_ZONE_HEIGHT = 110;
const FINISH_LINE_THICK = 16;
const SETTLE_VEL = 0.12;
const SETTLE_FRAMES = 6;

const nameInput = document.getElementById('nameInput');
const addBtn = document.getElementById('addBtn');
const startBtn = document.getElementById('startBtn');
const pauseBtn = document.getElementById('pauseBtn');
const endBtn = document.getElementById('endBtn');
const restartBtn = document.getElementById('restartBtn');
const namesListEl = document.getElementById('namesList');
const ballCountEl = document.getElementById('ballCount');
const finishedCountEl = document.getElementById('finishedCount');

const overlay = document.getElementById('overlay');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const restartAll = document.getElementById('restartAll');
const restartElimLast = document.getElementById('restartElimLast');

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

const sidebarLeaderboardEl = document.getElementById('sidebarLeaderboard');

let DPR = Math.max(1, window.devicePixelRatio || 1);
function resizeCanvas(){
  const wrap = canvas.parentElement.getBoundingClientRect();
  const width = Math.max(1200, wrap.width);
  const height = Math.max(window.innerHeight - 220, 1100);
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  canvas.width = Math.floor(width * DPR);
  canvas.height = Math.floor(height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

let participants = [];
let balls = [];
let pegs = [];
let finished = [];
let running = false;
let paused = false;
let startTime = 0;
let rafId = null;

function colorForIndex(i, total){
  const hue = Math.round((i * 360 / Math.max(1,total)) % 360);
  return `hsl(${hue} 85% 55%)`;
}

function renderParticipants(){
  namesListEl.innerHTML = '';
  participants.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'nameItem';
    div.innerHTML = `<div class="colorDot" style="background:${p.color}"></div>
                     <div style="flex:1">
                       <strong style="font-size:20px">${p.name}</strong>
                       <div class="small" style="margin-top:2px;font-size:14px;opacity:0.8">#${i+1}</div>
                     </div>
                     <button class="ghost" data-i="${i}" style="padding:10px 14px;font-size:15px">Remove</button>`;
    namesListEl.appendChild(div);
  });
  namesListEl.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.dataset.i);
      participants.splice(i,1);
      participants = participants.map((p, idx)=>({name:p.name, color:colorForIndex(idx, Math.max(8,participants.length)), active:true}));
      renderParticipants();
      resetLeaderboardUI();
    });
  });
  ballCountEl.textContent = participants.length;
}

function addNameFromInput(){
  const raw = nameInput.value || '';
  const name = raw.trim();
  if(!name) return;
  if(participants.some(p=>p.name.toLowerCase()===name.toLowerCase())){
    alert('Name already added.');
    nameInput.value = '';
    return;
  }
  const idx = participants.length;
  participants.push({name, color: colorForIndex(idx, Math.max(8, participants.length)), active:true});
  renderParticipants();
  resetLeaderboardUI();
  nameInput.value = '';
}
addBtn.addEventListener('click', addNameFromInput);
nameInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter') addNameFromInput();
});

pauseBtn.addEventListener('click', ()=>{
  if(!running) return;
  paused = !paused;
  pauseBtn.textContent = paused ? 'Resume' : 'Pause';
  if(!paused) loop();
});

/* End race: immediately stop loop and freeze */
endBtn.addEventListener('click', ()=>{
  if(!running) return;
  running = false;
  paused = false;
  if(rafId) cancelAnimationFrame(rafId);
  // zero velocities so they stop in place
  balls.forEach(b=>{
    b.vx = 0;
    b.vy = 0;
  });
  draw();
  updateLeaderboard(); // show current ranking as final
});

restartBtn.addEventListener('click', ()=>{
  participants = [];
  renderParticipants();
  resetGame();
  resetLeaderboardUI();
});

function buildMap(){
  pegs = [];
  const W = canvas.width / DPR;
  const H = canvas.height / DPR;

  const cols = Math.max(8, Math.floor(W / PEG_SPACING_X));
  const rows = Math.max(12, Math.floor((H * 0.72) / PEG_SPACING_Y) + 8);

  const xSpacing = W / Math.max(1, cols);
  const ySpacing = (H * 0.72) / Math.max(1, rows);

  for(let r=0;r<rows;r++){
    const y = 80 + r * ySpacing;
    const offset = (r % 2) * (xSpacing/2);
    for(let c=0;c<cols;c++){
      const x = offset + (c + 0.5) * xSpacing;
      const jitter = (Math.random()-0.5) * 4;
      pegs.push({x: x + jitter, y: y + (Math.random()-0.5)*3, r: PEG_RADIUS});
    }
  }
}

function resetGame(keepParticipants=false){
  balls = [];
  finished = [];
  running = false;
  paused = false;
  startTime = 0;
  renderParticipants();
  buildMap();
  draw();
  finishedCountEl.textContent = '0';
}

function spawnBalls(){
  balls = [];
  finished = [];
  const W = canvas.width / DPR;
  const spawnXStart = W * 0.12;
  const spawnXEnd = W * 0.88;
  const spacing = (spawnXEnd - spawnXStart) / Math.max(1, participants.length);
  participants.forEach((p, i)=>{
    if(!p.active) return;
    const x = spawnXStart + spacing * (i + 0.5) + (Math.random()-0.5)*8;
    const y = 40 + Math.random()*10;
    balls.push({
      id: i,
      name: p.name,
      color: p.color,
      x, y,
      vx: (Math.random()-0.5)*0.22,
      vy: 0,
      r: BALL_RADIUS,
      finished: false,
      finishTime: null,
      settleFrames: 0
    });
  });
  ballCountEl.textContent = balls.length;
}

function stepPhysics(){
  const W = canvas.width / DPR;
  const H = canvas.height / DPR;
  const finishTop = H - FINISH_ZONE_HEIGHT;

  for(let b of balls){
    if(b.finished) continue;

    b.vy += GRAVITY;
    b.vx *= FRICTION;
    b.vy *= FRICTION;
    b.x += b.vx;
    b.y += b.vy;

    // walls with nudge to avoid sticking
    if(b.x - b.r < 0){
      b.x = b.r + 0.5;
      b.vx = Math.abs(b.vx) * WALL_BOUNCE + WALL_NUDGE;
    }
    if(b.x + b.r > W){
      b.x = W - b.r - 0.5;
      b.vx = -Math.abs(b.vx) * WALL_BOUNCE - WALL_NUDGE;
    }

    for(let p of pegs){
      if(Math.abs(b.x - p.x) > (b.r + p.r + 6)) continue;
      if(Math.abs(b.y - p.y) > (b.r + p.r + 6)) continue;
      const dx = b.x - p.x;
      const dy = b.y - p.y;
      const dist = Math.hypot(dx,dy);
      const minDist = b.r + p.r;
      if(dist < minDist && dist > 0){
        const nx = dx / dist;
        const ny = dy / dist;
        const overlap = minDist - dist;
        b.x += nx * overlap;
        b.y += ny * overlap;
        const dot = b.vx * nx + b.vy * ny;
        b.vx = b.vx - 2 * dot * nx;
        b.vy = b.vy - 2 * dot * ny;
        b.vx *= 0.92;
        b.vy *= 0.92;
      }
    }

    if(b.y + b.r >= finishTop){
      b.y = Math.min(b.y, H - 8 - b.r);
      b.vx *= 0.9;
      b.vy = 0;

      const speed = Math.hypot(b.vx, b.vy);
      if(speed < SETTLE_VEL){
        b.settleFrames = (b.settleFrames || 0) + 1;
      } else {
        b.settleFrames = 0;
      }
      if(b.settleFrames >= SETTLE_FRAMES){
        b.finished = true;
        b.finishTime = performance.now() - startTime;
        finished.push({name: b.name, color: b.color, finishTime: b.finishTime});
        finishedCountEl.textContent = finished.length;
        b.vx = 0;
        b.vy = 0;
        b.y = finishTop + (FINISH_ZONE_HEIGHT/2) - b.r + (Math.random()*6 - 3);
      }
    }
  }
}

function buildLeaderboardItems(){
  const H = canvas.height / DPR;
  const finishCenter = H - FINISH_ZONE_HEIGHT/2;

  const items = balls.map(b=>{
    if(b.finished){
      return {
        name: b.name,
        color: b.color,
        finished: true,
        finishTime: b.finishTime || Number.MAX_SAFE_INTEGER,
        dist: 0
      };
    } else {
      const dist = Math.max(0, finishCenter - b.y);
      return {
        name: b.name,
        color: b.color,
        finished: false,
        finishTime: Number.MAX_SAFE_INTEGER,
        dist: dist
      };
    }
  });

  items.sort((a,b)=>{
    if(a.finished && !b.finished) return -1;
    if(!a.finished && b.finished) return 1;
    if(a.finished && b.finished){
      return a.finishTime - b.finishTime;
    }
    return a.dist - b.dist;
  });

  return items;
}

function resetLeaderboardUI(){
  sidebarLeaderboardEl.innerHTML = `
    <div style="font-size:14px;color:rgba(148,163,184,0.95);">
      Start a race to see live positions.
    </div>
  `;
}

function updateLeaderboard(){
  if(!running || balls.length === 0){
    return;
  }

  const items = buildLeaderboardItems();
  sidebarLeaderboardEl.innerHTML = '';
  items.forEach((item, idx)=>{
    const row = document.createElement('div');
    row.className = 'leaderboardItem';
    const rankDisplay =
      idx === 0 ? 'ðŸ¥‡' :
      idx === 1 ? 'ðŸ¥ˆ' :
      idx === 2 ? 'ðŸ¥‰' :
      `${idx+1}.`;
    row.innerHTML = `
      <div class="leaderboardRank">${rankDisplay}</div>
      <div class="leaderboardDot" style="background:${item.color}"></div>
      <div class="leaderboardName">${item.name}</div>
      <div class="leaderboardDist">
        ${item.finished ? 'Finished' : ''}
      </div>
    `;
    sidebarLeaderboardEl.appendChild(row);
  });
}

function draw(){
  const W = canvas.width / DPR;
  const H = canvas.height / DPR;
  ctx.clearRect(0,0,W,H);

  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#020617');
  g.addColorStop(1,'#000000');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  ctx.shadowColor = 'rgba(148,163,184,0.6)';
  ctx.shadowBlur = 8;
  ctx.fillStyle = 'rgba(148,163,184,0.4)';
  for(let p of pegs){
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.shadowBlur = 0;

  const finishTop = H - FINISH_ZONE_HEIGHT;

  ctx.fillStyle = 'rgba(15,23,42,0.9)';
  ctx.fillRect(0, finishTop, W, FINISH_ZONE_HEIGHT);

  const stripeY = finishTop - FINISH_LINE_THICK;
  const tileSize = 20;
  for(let x=0; x < W; x += tileSize){
    ctx.fillStyle = ((Math.floor(x/tileSize) % 2) === 0) ? '#111827' : '#e5e7eb';
    ctx.fillRect(x, stripeY, tileSize, FINISH_LINE_THICK);
  }

  ctx.fillStyle = '#e5e7eb';
  ctx.font = 'bold 26px Inter, Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.strokeStyle = 'rgba(15,23,42,0.9)';
  ctx.lineWidth = 4;
  ctx.strokeText('FINISH', W/2, stripeY - 22);
  ctx.fillText('FINISH', W/2, stripeY - 22);

  for(let b of balls){
    ctx.beginPath();
    ctx.ellipse(b.x+10, b.y+12, b.r*1.15, b.r*0.7, 0, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(0,0,0,0.55)';
    ctx.fill();

    const grad = ctx.createRadialGradient(
      b.x - b.r*0.4, b.y - b.r*0.7, b.r*0.15,
      b.x, b.y, b.r*1.35
    );
    grad.addColorStop(0, lighten(b.color, 25));
    grad.addColorStop(0.5, lighten(b.color, 10));
    grad.addColorStop(0.8, b.color);
    grad.addColorStop(1, darken(b.color, 20));
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(b.x - b.r*0.3, b.y - b.r*0.55, b.r*0.28, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.fill();

    ctx.font = 'bold 18px Inter, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(15,23,42,0.95)';
    ctx.strokeText(b.name, b.x, b.y - b.r - 16);
    ctx.fillStyle = b.color;
    ctx.fillText(b.name, b.x, b.y - b.r - 16);
  }

  ctx.fillStyle = 'rgba(226,232,240,0.95)';
  ctx.font = 'bold 20px Inter, Arial';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  ctx.fillText(`Finished: ${finished.length}`, 24, 34);
}

function lighten(hsl, amt){
  const m = hsl.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/);
  if(!m) return hsl;
  const h = m[1], s = m[2], l = Math.min(100, Number(m[3]) + amt);
  return `hsl(${h} ${s}% ${l}%)`;
}
function darken(hsl, amt){
  const m = hsl.match(/hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/);
  if(!m) return hsl;
  const h = m[1], s = m[2], l = Math.max(0, Number(m[3]) - amt);
  return `hsl(${h} ${s}% ${l}%)`;
}

function loop(){
  if(paused){
    rafId = requestAnimationFrame(loop);
    return;
  }
  stepPhysics();
  draw();
  updateLeaderboard();

  if(running){
    const allFinished = balls.length > 0 && balls.every(b => b.finished);
    if(allFinished){
      running = false;
      const items = buildLeaderboardItems();
      setTimeout(()=>showEndModal(items), 350);
      return;
    }
  }

  rafId = requestAnimationFrame(loop);
}

function showEndModal(items){
  if(!items || items.length === 0) return;
  const winner = items[0];
  const last = items[items.length-1];

  let listHtml = '';
  items.forEach((item, idx)=>{
    const icon =
      idx === 0 ? 'ðŸ¥‡' :
      idx === 1 ? 'ðŸ¥ˆ' :
      idx === 2 ? 'ðŸ¥‰' :
      `${idx+1}.`;
    listHtml += `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;font-size:16px;">
        <div style="width:34px;text-align:right;font-weight:700;">${icon}</div>
        <div style="width:14px;height:14px;border-radius:50%;background:${item.color};box-shadow:0 0 0 2px rgba(15,23,42,0.9);"></div>
        <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.name}</div>
        <div style="font-size:13px;color:rgba(148,163,184,0.95);text-align:right;min-width:80px;">
          ${item.finished ? 'Finished' : ''}
        </div>
      </div>
    `;
  });

  modalTitle.textContent = 'Leaderboard';
  modalBody.innerHTML = `
    <div style="margin-bottom:10px;font-size:17px;">
      <strong>ðŸ¥‡ ${winner.name}</strong><span style="opacity:0.8;"> â€” First place</span><br>
      <span style="opacity:0.8;">Last place: <strong>${last.name}</strong></span>
    </div>
    <div style="margin-top:10px;margin-bottom:4px;font-weight:600;font-size:16px;">Full Standings</div>
    <div style="max-height:260px;overflow:auto;padding-right:4px;">
      ${listHtml}
    </div>
  `;
  overlay.style.display = 'block';
  modal.style.display = 'block';
}

restartAll.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  modal.style.display = 'none';
  participants = participants.map(p=>({name:p.name,color:p.color,active:true}));
  resetGame();
  resetLeaderboardUI();
});
restartElimLast.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  modal.style.display = 'none';
  if(finished.length === 0) return;
  finished.sort((a,b)=>a.finishTime - b.finishTime);
  const last = finished[finished.length-1];
  participants = participants.filter(p=>p.name !== last.name);
  renderParticipants();
  resetGame();
  resetLeaderboardUI();
});

startBtn.addEventListener('click', ()=>{
  if(running) return;
  if(participants.length === 0) return alert('Add at least one name.');
  participants = participants.map((p, idx)=>({name:p.name,color:colorForIndex(idx, Math.max(8,participants.length)),active:true}));
  renderParticipants();
  resetGame(true);
  spawnBalls();
  running = true;
  paused = false;
  pauseBtn.textContent = 'Pause';
  startTime = performance.now();
  if(rafId) cancelAnimationFrame(rafId);
  loop();
});

resetGame();
resetLeaderboardUI();
ctx.fillStyle = 'rgba(226,232,240,0.85)';
ctx.font = 'bold 26px Inter, Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.fillText('Type a name and press Enter, then Start Race', canvas.width/(2*DPR), canvas.height/(2*DPR));
</script>
</body>
</html>
